{% extends 'layout.html' %}
{% block title %}
Ãœbersichtskarte
{% endblock %}
{% block styles %}
    <link rel="stylesheet" href="{{ url_for('static', filename='large_map.css') }}">
{% endblock %}
{% block content %}
<div id="map" style="height: 100vh;"></div>
<form id="locationForm" action="{{ url_for('views.display_map')}}" method="post" enctype="multipart/form-data">
        <div class="input-field col s12" hidden>
            <input id="latitude" type="text" class="validate" name="latitude" required>
            <label for="latitude">Latitude</label>
        </div>
        <div class="input-field col s12" hidden>
            <input id="longitude" type="text" class="validate" name="longitude" required>
            <label for="longitude">Longitude</label>
        </div>
        <div class="fixed-action-btn" style="position: absolute; bottom: 45px; right: 24px;">
            <div class="btn-floating btn-large lime file-field" >
                <i class="large material-icons">camera</i>
                <input id="photoField" type="file" name="photo" accept="image/jpg, image/jpeg, image/png" capture="camera" >
            </div>
        </div>
        <div class="file-path-wrapper" hidden>
            <input class="file-path validate" type="text">
        </div>
<button class="btn waves-effect waves-light" type="submit">Submit</button>
</form>
<script>
document.getElementById('photoField').addEventListener('change', function() {
  // Check if the field is not empty
  if (this.value.trim() !== '') {
    // Submit the form
    document.getElementById('locationForm').submit();
  }
});

</script>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
    var map = L.map('map').setView([49.7596, 6.6439], 13); // Initialize map with a dummy location

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    function onLocationFound(e) {
        var radius = e.accuracy / 2; // e.accuracy is in meters

        L.circle(e.latlng, radius).addTo(map);
        document.getElementById('latitude').value = e.latlng[0];
        document.getElementById('longitude').value = e.latlng[1];

        map.setView(e.latlng, 13); // Set the map extent to the user's location
    }

    function onLocationError(e) {
        alert(e.message);
    }

    map.on('locationfound', onLocationFound);
    map.on('locationerror', onLocationError);

    // This method watches the user's location, updates happen based on device movement and settings
    navigator.geolocation.watchPosition((position) => {
        map.fire('locationfound', {
            latlng: [position.coords.latitude, position.coords.longitude],
            accuracy: position.coords.accuracy
        });
    }, onLocationError, {
        enableHighAccuracy: true,
        maximumAge: 10000,
        timeout: 5000
    });

    // Fetch locations from API endpoint
    fetch('/api/locations')
        .then(response => response.json())
        .then(data => {
            if (data.length > 0) {
                // Add markers for each location
                data.forEach(location => {
                    var marker = L.marker([location.latitude, location.longitude]).addTo(map)
                    marker.on('click', function() {
                        window.location.href = location.link
                    });
                });
            }
    });
</script>
{% endblock %}